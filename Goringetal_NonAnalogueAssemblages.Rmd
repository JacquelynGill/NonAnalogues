No-Analogues in North American Pollen Space
========================================================

Abstract
------------------------

Introduction
------------------------
Our investigation of non-analogues, both in the past and in the future is tied to differences from modern pollen data.  THe concern with a future of no-analogues is tied to our lack of understanding, both in how the process of change will unfold, and in how ecosystem services are provided by these vegetation communities for which we have no analogue.
To assist in this endevour, we examine pollen records from the Neotoma Database, searching through the past, from the late-glacial to the modern to examine in which cases pollen assemblages appear to be non-analogue from the previous time period.

Methods
------------------------
We compile records of pollen from depositional records in the Neotoma Database.  To assess whether pollen assemblages are 'non-analogue' we estimate squared-chord distance from pollen samples to a reference set that includes (1) all samples in the Neotoma Database that are between 250 and 750 calibrated years older than the sample, and (2) includes samples from the reference site.

```{r checkFileCreation, echo=FALSE, message=FALSE}

if('data/all_sites_compiled.RData' %in% list.files('data/')){
  create_date <- file.info('data/all_sites_compiled.RData')$mtime  
  load('data/all_sites_compiled.RData')
}
if(!'data/all_sites_compiled.RData' %in% list.files('data/')){
  source('R/load_datasets.R')
  
  create_date <- file.info('data/all_sites_compiled.RData')$mtime
}

include <- !(is.na(compiled.pollen$age) | 
               is.na(compiled.pollen$depth) | 
               compiled.pollen$age > 22000 |
               compiled.pollen$lat < 20 |
               compiled.pollen$long > -40)

compiled.pollen <- compiled.pollen[include, ]
compiled.pollen$sitename <- as.character(compiled.pollen$sitename)

```
Pollen data from Neotoma was accessed on `r create_date` using the `neotoma` pacakge for R (Goring, 2013; `http://www.github.com/ropensci/neotoma`).  The dataset includes `r length(unique(compiled.pollen$sitename))` sites from across North America (Figure 1a), with `r nrow(compiled.pollen)` samples younger than 21kyr cal. BP (Figure 1b).  To assess the presence of no-analogues we look for the 95% CI of dissimilarities for all samples within an age-range.  A sample is considered to be no-analogue if the minimum dissimilarity between it and the samples pulled from the earlier sample pool is greater than the 95% CI  for dissimilarity within the pool.

```{r Figure1Plots, message=FALSE, echo=FALSE, warning=FALSE, fig.width=6, fig.height=4}
library(ggplot2)
library(gridExtra)

#  Get rid of western sites.
compiled.pollen <- compiled.pollen[compiled.pollen$long > -100,]

indiv.sites <- data.frame(site = unique(compiled.pollen$sitename),
                          compiled.pollen[!duplicated(compiled.pollen$sitename), 4:5],
                          samples = as.vector(table(compiled.pollen$sitename)))

points <- ggplot(indiv.sites) + 
            geom_point(aes(x = long, y = lat, size = samples), alpha=0.3) +
            theme_bw()

bins <- ggplot(compiled.pollen) + 
          geom_bar(aes(x = age), 
                   breaks = seq(-100, 22000, by = 500), 
                   fill='gray', color='black') +
          scale_x_continuous(expand=c(0, 0), limits=c(-100, 21000)) +
          scale_y_continuous(expand=c(0, 0), limits=c(0, 4000))

grid.arrange(points, bins, ncol=2)

```
**Figure 1**. *Sample plot locations and bin sizes for each age class*.

Because sample size may affect our ability to calculate the 95% CI we also use the squared-chord dissimilarity estimate reported in Gill et al. (2009) of XXX as a secondary check.  This allows us to detect no-analogues using multiple methods.


```{r}

compiled.pollen[is.na(compiled.pollen)] <- 0

rep.frame <- data.frame(site = compiled.pollen$sitename,
                        age = compiled.pollen$age,
                        matrix(nrow=nrow(compiled.pollen), ncol=100))

for(i in 1:nrow(rep.frame)){
  
  #  For each sample in the dataset we need to find it, and then check if it
  #  has any samples that are between 250 and 750 years older than it.
  right.site <- compiled.pollen$sitename == rep.frame$site[i]
  site.ages <-  compiled.pollen$age[right.site]
  
  right.age <- any((site.ages > (rep.frame$age[i] + 250)) & 
                     (site.ages < (rep.frame$age[i] + 750)))
  
  if(any(right.age)){
    
    #  Now we know that the sample has something to compare to (that is 
    #  between 250 and 750 years older), we can create a vector for the sample.
    #  We exclude 'Other', because it's super big some times.
    
    arrow <- compiled.pollen[i, 7:ncol(compiled.pollen)]
    arrow <- arrow / sum(arrow)
    
    older <- abs((rep.frame$time[i] + 500) - compiled.pollen$age) < 500
    
    calib.samples <- compiled.pollen[older, ]
      
    for(j in 1:100){
      if(nrow(bin.samples) > 1){
        target <- bin.samples[sample(nrow(bin.samples), 1), ]
      }
      else{
        target <- bin.samples
      }
      
      unique.sites <- length(unique(calib.samples))
      
      calib.samples <- calib.samples[order(calib.samples$sitename),]
      site.freq <- as.numeric(table(calib.samples$sitename))
      
      probs <- rep(site.freq / nrow(calib.samples), site.freq)
        
      subsample <- sample(x = 1:nrow(calib.samples), 
                          size = unique.sites, 
                          replace = TRUE, 
                          prob = probs)
      
      arrow <- calib.samples[subsample,]
      
      #  Now get the minimum distance:
      target.vec <- as.vector(target[,6:ncol(target)])
      target.vec <- sqrt(target.vec /sum(target.vec, na.rm=TRUE))
      target.vec[is.na(target.vec)] <- 0
      
      arrow.mat <- as.matrix(arrow[,6:ncol(arrow)])
      arrow.mat <- sqrt(arrow.mat /rowSums(arrow.mat, na.rm=TRUE))
      arrow.mat[is.na(arrow.mat)] <- 0
      
      dist.vals <- sqrt(colSums(apply(arrow.mat, 1, function(x) (x - target.vec)^2), na.rm=TRUE))
      
      rep.frame[i, j+2] <- min(dist.vals)
      cat(i, j, '\n')
    }
  }
  
}

```
